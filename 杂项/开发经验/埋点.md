# 关于埋点

## 数据埋点与服务监控

数据埋点一定要放在一个具体的环境（服务监控）才有意义，可以说，数据埋点是为服务监控服务的。

**为什么需要？**
不管是网站还是 APP 或者小程序，本地服务运行的再好，都无法保证在用户那一侧的运行是一定不会出错。如果一旦在用户端报错或卡顿，服务端无法及时了解情况。

**概述**
收集用户在使用过程中，出现的各种各样的问题，以便于及时进行调整

**监控方面**
错误监控:什么样的错误？发生在什么地方（哪一行代码）？
性能监控：是否有白屏？是否有卡顿？FP、FCP、LCS 等性能指标

行为监控：停留时间？

**服务提供商**

ARMS
神策
sentry

**两者关系**
数据埋点是技术层面的事。
服务监控是业务层面的事。
数据埋点是对服务监控收集用户信息的技术实现

**数据埋点实现层面**

- 非侵入

- 侵入

## 一些名词

**UV（Unique Visitor）**
通过互联网访问服务的自然人
**PV（Page View）**
页面的浏览量和点击量
**VV（Visit View）**
所有访客一天内访问网站的次数

## 埋点方案

- 手动埋点

- 可视化埋点：

- 无痕埋点（全埋点）：对全局所有事件和页面加载周期进行拦截埋点

## 常见埋点方式

1. 直接发送请求:通过 XMLHttpRequest(XHR)或 Fetch API 直接发送埋点请求。可以在埋点代码中构建相关数据,比如用户信息、页面信息和事件信息,然后以 GET 或 POST 请求方式发送给后端接收和处理。

2. 图像请求:利用浏览器的 Image 对象**思考：为什么？？？**,创建一个图片请求并将埋点数据作为 URL 中的参数传递。后端接收到该请求后会记录相关数据。这种方式通常用于跨域请求或者简单的埋点需求,不需要关注返回结果。

3. Beacon API:使用 Beacon API 可以在页面卸载时异步地发送埋点请求,不会阻塞页面的卸载过程。Beacon API
   适用于一些无需等待服务器响应的快速埋点需求,比如发送一些统计数据。

4. WebSocket:通过 WebSocket 建立与后端的持久连接,将埋点数据作为消息发送给后端。WebSocket 可以实现
   实时埋点数据的发送和接收,并且对数据量较大、需要实时反馈和双向通信的场景更为适用。

### 常见埋点行为

常见埋点行为

1. 点击事件

2. 页面的进入访问事件

3. 页面停留时长

4. 框架异常/JS 异常错误捕获

5. 资源加载异常

6. 页面性能关键节点(LCP、FCP、FP、FPS 等)

7. 请求的成功与错误捕获

### 考量标准

- 低侵入性：埋点应与业务代码进行分离
- 规范性：通过统一接口处理埋点逻辑

## 服务监控的方面

### 数据监控

- PV/UV
- 页面停留时长
- 访问源网址
- 用户在页面内的行为

### 性能监控

- 不同用户、不同设备、不同系统下的首屏加载时长
- 白屏时间
- 网络请求时长
- 静态资源请求时长
- 页面渲染时长

### 异常/错误监控

- js 异常
- 样式异常
